/**
 * @license
 * Copyright 2020 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@tensorflow/tfjs-core"),require("seedrandom")):"function"==typeof define&&define.amd?define(["exports","@tensorflow/tfjs-core","seedrandom"],e):e((t=t||self).tf=t.tf||{},t.tf,t.seedrandom)}(this,(function(t,e,r){"use strict";var a=function(t,e){return(a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};function n(t,e,r,a){return new(r||(r=Promise))((function(n,o){function i(t){try{d(a.next(t))}catch(t){o(t)}}function s(t){try{d(a.throw(t))}catch(t){o(t)}}function d(t){var e;t.done?n(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(i,s)}d((a=a.apply(t,e||[])).next())}))}function o(t,e){var r,a,n,o,i={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(r)throw new TypeError("Generator is already executing.");for(;i;)try{if(r=1,a&&(n=2&o[0]?a.return:o[0]?a.throw||((n=a.return)&&n.call(a),0):a.next)&&!(n=n.call(a,o[1])).done)return n;switch(a=0,n&&(o=[2&o[0],n.value]),o[0]){case 0:case 1:n=o;break;case 4:return i.label++,{value:o[1],done:!1};case 5:i.label++,a=o[1],o=[0];continue;case 7:o=i.ops.pop(),i.trys.pop();continue;default:if(!(n=i.trys,(n=n.length>0&&n[n.length-1])||6!==o[0]&&2!==o[0])){i=0;continue}if(3===o[0]&&(!n||o[1]>n[0]&&o[1]<n[3])){i.label=o[1];break}if(6===o[0]&&i.label<n[1]){i.label=n[1],n=o;break}if(n&&i.label<n[2]){i.label=n[2],i.ops.push(o);break}n[2]&&i.ops.pop(),i.trys.pop();continue}o=e.call(t,i)}catch(t){o=[6,t],a=0}finally{r=n=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}}function i(t,r){Array.isArray(t)||(t=[t]),t.forEach((function(t){null!=t&&e.util.assert("complex64"!==t.dtype,(function(){return r+" does not support complex64 tensors in the CPU backend."}))}))}function s(t,r,a,n,o,i){for(var s=o.strideHeight,d=o.strideWidth,p=o.dilationHeight,u=o.dilationWidth,h=o.effectiveFilterHeight,l=o.effectiveFilterWidth,f=o.padInfo.top,c=o.padInfo.left,v="max"===i?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY,y=e.buffer(o.outShape,a),m=y.values,g=o.outShape[1]*o.outShape[2]*o.outShape[3],I=o.outShape[2]*o.outShape[3],S=o.outShape[3],b=0;b<o.batchSize;++b)for(var k=b*g,x=b*n[0],M=0;M<o.inChannels;++M)for(var F=0;F<o.outHeight;++F)for(var A=F*s-f,T=Math.max(0,A),D=Math.min(o.inHeight,h+A),w=k+F*I,N=0;N<o.outWidth;++N){for(var z=N*d-c,W=Math.max(0,z),_=Math.min(o.inWidth,l+z),H=v,O=0,C=0,B=T;B<D;B+=p){for(var E=x+B*n[1],P=W;P<_;P+=u){var R=t[E+P*n[2]+M];"max"===i&&R>H?H=R:"avg"===i&&(O+=R,C++)}if(isNaN(H))break}m[w+N*S+M]="avg"===i?O/C:H}return y}function d(t,r,a,n,o,i){void 0===o&&(o=!1),void 0===i&&(i=!1);for(var s=e.buffer(n.outShape,"int32"),d=n.strideHeight,p=n.strideWidth,u=n.dilationHeight,h=n.dilationWidth,l=n.effectiveFilterHeight,f=n.effectiveFilterWidth,c=n.padInfo.top,v=n.padInfo.left,y=e.buffer(r,a,t),m=0;m<n.batchSize;++m)for(var g=0;g<n.inChannels;++g)for(var I=0;I<n.outHeight;++I){for(var S=I*d-c,b=S;b<0;)b+=u;for(var k=Math.min(n.inHeight,l+S),x=0;x<n.outWidth;++x){for(var M=x*p-v,F=M;F<0;)F+=h;for(var A=Math.min(n.inWidth,f+M),T=Number.NEGATIVE_INFINITY,D=-1,w=b;w<k;w+=u)for(var N=w-S,z=F;z<A;z+=h){var W=z-M,_=y.get(m,w,z,g);_>T&&(T=_,D=o?i?((m*n.inHeight+w)*n.inWidth+z)*n.inChannels+g:(w*n.inWidth+z)*n.inChannels+g:N*f+W)}s.set(D,m,I,x,g)}}return s}var p=e.kernel_impls.nonMaxSuppressionV3Impl,u=e.kernel_impls.split,h=e.kernel_impls.tile,l=e.kernel_impls.topkImpl,f=e.kernel_impls.whereImpl;function c(t,e,r,a){if("linear"===r)return t.linear(e);if("relu"===r)return t.relu(e);if("elu"===r)return t.elu(e);if("relu6"===r)return t.relu6(e);if("prelu"===r)return t.prelu(e,a);throw new Error("Activation "+r+" has not been implemented for the CPU backend.")}var v=function(t){function v(){var r=t.call(this)||this;return r.blockSize=48,r.firstUse=!0,r.data=new e.DataStorage(r,e.engine()),r}return function(t,e){function r(){this.constructor=t}a(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}(v,t),v.prototype.write=function(t,r,a){this.firstUse&&(this.firstUse=!1,e.env().get("IS_NODE")&&e.backend_util.warn("\n============================\nHi there ðŸ‘‹. Looks like you are running TensorFlow.js in Node.js. To speed things up dramatically, install our node backend, which binds to TensorFlow C++, by running npm i @tensorflow/tfjs-node, or npm i @tensorflow/tfjs-node-gpu if you have CUDA. Then call require('@tensorflow/tfjs-node'); (-gpu suffix for CUDA) at the start of your program. Visit https://github.com/tensorflow/tfjs-node for more details.\n============================"));var n={};return this.data.set(n,{values:t,dtype:a,refCount:1}),n},v.prototype.incRef=function(t){this.data.get(t).refCount++},v.prototype.decRef=function(t){this.data.has(t)&&this.data.get(t).refCount--},v.prototype.move=function(t,e,r,a){this.data.set(t,{values:e,dtype:a,refCount:1})},v.prototype.numDataIds=function(){return this.data.numDataIds()},v.prototype.read=function(t){return n(this,void 0,void 0,(function(){return o(this,(function(e){return[2,this.readSync(t)]}))}))},v.prototype.readSync=function(t){var r=this.data.get(t),a=r.dtype,n=r.complexTensors;if("complex64"===a){var o=this.readSync(n.real.dataId),i=this.readSync(n.imag.dataId);return e.backend_util.mergeRealAndImagArrays(o,i)}return this.data.get(t).values},v.prototype.bufferSync=function(t){var r=this.readSync(t.dataId),a=r;if("string"===t.dtype)try{a=r.map((function(t){return e.util.decodeString(t)}))}catch(t){throw new Error("Failed to decode encoded string bytes into utf-8")}return e.buffer(t.shape,t.dtype,a)},v.prototype.makeOutput=function(t,r,a){var n=this.write(t,r,a);return e.engine().makeTensorFromDataId(n,r,a,this)},v.prototype.disposeData=function(t){if(this.data.has(t)){var e=this.data.get(t).complexTensors;null!=e&&(e.real.dispose(),e.imag.dispose()),this.data.delete(t)}},v.prototype.disposeIntermediateTensorInfo=function(t){var e=t.dataId;if(this.data.has(e)){var r=this.data.get(e);r.refCount--,r.refCount<1&&this.disposeData(e)}},v.prototype.time=function(t){return n(this,void 0,void 0,(function(){var r;return o(this,(function(a){return r=e.util.now(),t(),[2,{kernelMs:e.util.now()-r}]}))}))},v.prototype.memory=function(){return{unreliable:!0,reasons:["The reported memory is an upper bound. Due to automatic garbage collection, the true allocated memory may be less."]}},v.prototype.complex=function(t,r){var a=this.makeOutput(null,t.shape,"complex64");return this.data.get(a.dataId).complexTensors={real:e.engine().keep(t.clone()),imag:e.engine().keep(r.clone())},a},v.prototype.real=function(t){return this.data.get(t.dataId).complexTensors.real.clone()},v.prototype.imag=function(t){return this.data.get(t.dataId).complexTensors.imag.clone()},v.prototype.slice=function(t,r,a){if(i(t,"slice"),e.slice_util.isSliceContinous(t.shape,r,a)){var n=e.slice_util.computeFlatOffset(r,t.strides),o=e.util.sizeFromShape(a),s=this.readSync(t.dataId);return e.tensor(s.subarray(n,n+o),a,t.dtype)}for(var d=e.buffer(a,t.dtype),p=this.bufferSync(t),u=0;u<d.size;++u){var h=d.indexToLoc(u).map((function(t,e){return t+r[e]}));d.values[u]=p.get.apply(p,h)}return d.toTensor()},v.prototype.stridedSlice=function(t,r,a,n){i(t,"stridedSlice");var o=e.slice_util.computeOutShape(r,a,n);if(o.some((function(t){return 0===t})))return e.tensor([],o);for(var s=e.buffer(o,t.dtype),d=this.bufferSync(t),p=0;p<s.size;p++){for(var u=s.indexToLoc(p),h=new Array(u.length),l=0;l<h.length;l++)h[l]=u[l]*n[l]+r[l];s.set.apply(s,[d.get.apply(d,h)].concat(u))}return s.toTensor()},v.prototype.diag=function(t){for(var r=this.readSync(t.dataId),a=e.buffer([t.size,t.size],t.dtype),n=a.values,o=0;o<r.length;o++)n[o*t.size+o]=r[o];return a.toTensor()},v.prototype.unstack=function(t,e){for(var r=t.shape[e],a=new Array(t.rank-1),n=0,o=0;o<t.rank;o++)o!==e&&(a[n++]=t.shape[o]);var i=new Array(t.rank).fill(0),s=t.shape.slice();s[e]=1;var d=new Array(r);for(o=0;o<d.length;o++)i[e]=o,d[o]=this.slice(t,i,s).reshape(a);return d},v.prototype.reverse=function(t,r){i(t,"reverse");for(var a=e.buffer(t.shape,t.dtype),n=this.bufferSync(t),o=function(e){var o=a.indexToLoc(e),i=o.slice();r.forEach((function(e){return i[e]=t.shape[e]-1-i[e]})),a.set.apply(a,[n.get.apply(n,i)].concat(o))},s=0;s<a.size;s++)o(s);return a.toTensor()},v.prototype.concat=function(t,r){var a=this;if("complex64"===t[0].dtype){var n=t.map((function(t){return e.real(t)})),o=t.map((function(t){return e.imag(t)}));return e.complex(this.concat(n,r),this.concat(o,r))}var i=t.map((function(t){var a=e.util.sizeFromShape(t.shape.slice(r));return t.as2D(-1,a)})),s=e.backend_util.computeOutShape(i.map((function(t){return t.shape})),1),d=e.buffer(s,t[0].dtype).values;if(1===i[0].shape[0]){var p=0;i.forEach((function(t){d.set(a.readSync(t.dataId),p),p+=t.size}))}else{var u=0;i.forEach((function(t){for(var e=a.readSync(t.dataId),r=0,n=0;n<t.shape[0];++n)for(var o=n*s[1]+u,i=0;i<t.shape[1];++i)d[o+i]=e[r++];u+=t.shape[1]}))}var h=e.backend_util.computeOutShape(t.map((function(t){return t.shape})),r);return e.tensor(d,h,t[0].dtype)},v.prototype.neg=function(t){return i(t,"neg"),this.multiply(e.scalar(-1),t)},v.prototype.add=function(t,r){return"complex64"===t.dtype||"complex64"===r.dtype?this.broadcastedBinaryComplexOp(t.cast("complex64"),r.cast("complex64"),(function(t,e,r,a){return{real:t+r,imag:e+a}})):this.broadcastedBinaryOp(t,r,e.upcastType(t.dtype,r.dtype),(function(t,e){return t+e}))},v.prototype.addN=function(t){var r=this;i(t,"addN");for(var a=t.map((function(t){return r.readSync(t.dataId)})),n=e.buffer(t[0].shape,t[0].dtype),o=n.values,s=0;s<t.length;s++)for(var d=a[s],p=0;p<o.length;p++)o[p]+=d[p];return n.toTensor()},v.prototype.softmax=function(t,r){var a=e.util.parseAxisParam([r],t.shape),n=e.max(t,a),o=e.backend_util.expandShapeToKeepDim(n.shape,a),i=this.subtract(t,n.reshape(o)),s=this.exp(i),d=this.sum(s,a).reshape(o);return e.div(s,d)},v.prototype.subtract=function(t,r){return"complex64"===t.dtype||"complex64"===r.dtype?this.broadcastedBinaryComplexOp(t.cast("complex64"),r.cast("complex64"),(function(t,e,r,a){return{real:t-r,imag:e-a}})):this.broadcastedBinaryOp(t,r,e.upcastType(t.dtype,r.dtype),(function(t,e){return t-e}))},v.prototype.pow=function(t,e){return i([t,e],"pow"),this.broadcastedBinaryOp(t,e,t.dtype,(function(t,e){return Math.pow(t,e)}))},v.prototype.batchMatMul=function(t,r,a,n){i([t,r],"matMul");for(var o=a?t.shape[1]:t.shape[2],s=a?t.shape[2]:t.shape[1],d=n?r.shape[1]:r.shape[2],p=t.shape[0],u=this.readSync(t.dataId),h=this.readSync(r.dataId),l=a?[t.strides[0],1,t.strides[1]]:[t.strides[0],t.strides[1],1],f=l[0],c=l[1],v=l[2],y=n?[1,r.strides[1],r.strides[0]]:[r.strides[1],1,r.strides[0]],m=y[0],g=y[1],I=y[2],S=s*d,b=e.buffer([p,s,d],t.dtype),k=b.values,x=this.blockSize,M=0;M<p;M++)for(var F=0;F<s;F+=x)for(var A=0;A<d;A+=x)for(var T=0;T<o;T+=x)for(var D=Math.min(F+x,s),w=Math.min(A+x,d),N=Math.min(T+x,o),z=F;z<D;z++)for(var W=A;W<w;W++){for(var _=0,H=T;H<N;H++)_+=u[M*f+z*c+H*v]*h[H*m+W*g+M*I];k[M*S+(z*d+W)]+=_}return b.toTensor()},v.prototype.fusedBatchMatMul=function(t){var e=t.a,r=t.b,a=t.transposeA,n=t.transposeB,o=t.bias,i=t.activation,s=t.preluActivationWeights,d=this.batchMatMul(e,r,a,n);return o&&(d=this.add(d,o)),i&&(d=c(this,d,i,s)),d},v.prototype.multiply=function(t,r){return"complex64"===t.dtype||"complex64"===r.dtype?this.broadcastedBinaryComplexOp(t.cast("complex64"),r.cast("complex64"),(function(t,e,r,a){return{real:t*r-e*a,imag:t*a+e*r}})):this.broadcastedBinaryOp(t,r,e.upcastType(t.dtype,r.dtype),(function(t,e){return t*e}))},v.prototype.floorDiv=function(t,e){i([t,e],"floorDiv");return this.broadcastedBinaryOp(t,e,"int32",(function(t,e){return Math.floor(t/e)}))},v.prototype.sum=function(t,r){i(t,"sum"),e.backend_util.assertAxesAreInnerMostDims("sum",r,t.rank);for(var a=e.backend_util.computeOutAndReduceShapes(t.shape,r),n=a[0],o=a[1],s=e.upcastType(t.dtype,"int32"),d=e.zeros(n,s),p=e.util.sizeFromShape(o),u=this.readSync(d.dataId),h=this.readSync(t.dataId),l=0;l<u.length;++l){for(var f=l*p,c=0,v=0;v<p;++v)c+=h[f+v];u[l]=c}return d},v.prototype.prod=function(t,r){i(t,"sum");for(var a=e.backend_util.computeOutAndReduceShapes(t.shape,r),n=a[0],o=a[1],s=e.upcastType(t.dtype,"int32"),d=e.zeros(n,s),p=e.util.sizeFromShape(o),u=this.readSync(d.dataId),h=this.readSync(t.dataId),l=0;l<u.length;++l){for(var f=l*p,c=1,v=0;v<p;++v)c*=h[f+v];u[l]=c}return d},v.prototype.unsortedSegmentSum=function(t,r,a){i(t,"unsortedSegmentSum");for(var n=[],o=t.rank-r.rank,s=0;s<o;++s)r=r.expandDims(s+1);for(s=0;s<a;++s){var d=e.scalar(s,"int32"),p=e.equal(d,r).asType("float32").mul(t).sum(0);n.push(p)}return e.stack(n)},v.prototype.argMin=function(t,r){i(t,"argMin");var a=[r];e.backend_util.assertAxesAreInnerMostDims("argMin",a,t.rank);for(var n=e.backend_util.computeOutAndReduceShapes(t.shape,a),o=n[0],s=n[1],d=e.zeros(o,"int32"),p=e.util.sizeFromShape(s),u=this.readSync(d.dataId),h=this.readSync(t.dataId),l=0;l<u.length;++l){for(var f=l*p,c=h[f],v=0,y=0;y<p;++y){var m=h[f+y];m<c&&(c=m,v=y)}u[l]=v}return d},v.prototype.argMax=function(t,r){i(t,"argMax");var a=[r];e.backend_util.assertAxesAreInnerMostDims("argMax",a,t.rank);for(var n=e.backend_util.computeOutAndReduceShapes(t.shape,a),o=n[0],s=n[1],d=e.zeros(o,"int32"),p=e.util.sizeFromShape(s),u=this.readSync(d.dataId),h=this.readSync(t.dataId),l=0;l<u.length;++l){for(var f=l*p,c=h[f],v=0,y=0;y<p;++y){var m=h[f+y];m>c&&(c=m,v=y)}u[l]=v}return d},v.prototype.cumsum=function(t,r,a,n){if(i(t,"cumsum"),r!==t.rank-1)throw new Error("backend.cumsum in CPU expects an inner-most axis="+(t.rank-1)+" but got axis="+r);for(var o=e.upcastType(t.dtype,"int32"),s=e.zeros(t.shape,o),d=this.readSync(s.dataId),p=this.readSync(t.dataId),u=t.shape[t.rank-1],h=n?function(t,e){return t+u-e-1}:function(t,e){return t+e},l=0;l<p.length;l+=u)for(var f=0;f<u;f++){var c=h(l,f);if(0===f)d[c]=a?0:p[c];else{var v=h(l,f-1);d[c]=a?p[v]+d[v]:p[c]+d[v]}}return s},v.prototype.equal=function(t,e){return i([t,e],"equal"),this.broadcastedBinaryOp(t,e,"bool",(function(t,e){return t===e?1:0}))},v.prototype.notEqual=function(t,e){return i([t,e],"notEqual"),this.broadcastedBinaryOp(t,e,"bool",(function(t,e){return t!==e?1:0}))},v.prototype.less=function(t,e){return i([t,e],"less"),this.broadcastedBinaryOp(t,e,"bool",(function(t,e){return t<e?1:0}))},v.prototype.lessEqual=function(t,e){return i([t,e],"lessEqual"),this.broadcastedBinaryOp(t,e,"bool",(function(t,e){return t<=e?1:0}))},v.prototype.greater=function(t,e){return i([t,e],"greater"),this.broadcastedBinaryOp(t,e,"bool",(function(t,e){return t>e?1:0}))},v.prototype.greaterEqual=function(t,e){return i([t,e],"greaterEqual"),this.broadcastedBinaryOp(t,e,"bool",(function(t,e){return t>=e?1:0}))},v.prototype.logicalNot=function(t){i(t,"logicalNot");for(var e=this.readSync(t.dataId),r=new Uint8Array(e.length),a=0;a<e.length;++a)r[a]=e[a]?0:1;return this.makeOutput(r,t.shape,"bool")},v.prototype.logicalAnd=function(t,e){return i([t,e],"logicalAnd"),this.broadcastedBinaryOp(t,e,"bool",(function(t,e){return t&&e}))},v.prototype.logicalOr=function(t,e){return i([t,e],"logicalOr"),this.broadcastedBinaryOp(t,e,"bool",(function(t,e){return t||e}))},v.prototype.select=function(t,r,a){i([t,r,a],"select");for(var n=this.readSync(t.dataId),o=this.readSync(r.dataId),s=this.readSync(a.dataId),d=e.zeros(r.shape,e.upcastType(r.dtype,a.dtype)),p=this.readSync(d.dataId),u=0,h=0===t.rank||t.rank>1||1===r.rank?1:e.util.sizeFromShape(r.shape.slice(1)),l=0;l<n.length;l++)for(var f=0;f<h;f++)1===n[l]?p[u++]=o[l]:p[u++]=s[l];return d},v.prototype.where=function(t){i([t],"where");var e=this.readSync(t.dataId);return f(t.shape,e)},v.prototype.topk=function(t,e,r){i(t,"topk");var a=this.readSync(t.dataId);return l(a,t.shape,t.dtype,e,r)},v.prototype.min=function(t,r){i(t,"min"),e.backend_util.assertAxesAreInnerMostDims("min",r,t.rank);for(var a=e.backend_util.computeOutAndReduceShapes(t.shape,r),n=a[0],o=a[1],s=e.zeros(n,t.dtype),d=e.util.sizeFromShape(o),p=this.readSync(s.dataId),u=this.readSync(t.dataId),h=0;h<p.length;++h){for(var l=h*d,f=u[l],c=0;c<d;++c){var v=u[l+c];v<f&&(f=v)}p[h]=f}return s},v.prototype.minimum=function(t,e){return i([t,e],"minimum"),this.broadcastedBinaryOp(t,e,t.dtype,(function(t,e){return Math.min(t,e)}))},v.prototype.mod=function(t,e){return i([t,e],"mod"),this.broadcastedBinaryOp(t,e,t.dtype,(function(t,e){var r=t%e;return t<0&&e<0||t>=0&&e>=0?r:(r+e)%e}))},v.prototype.maximum=function(t,e){return i([t,e],"maximum"),this.broadcastedBinaryOp(t,e,t.dtype,(function(t,e){return Math.max(t,e)}))},v.prototype.all=function(t,r){i(t,"all"),e.backend_util.assertAxesAreInnerMostDims("all",r,t.rank);for(var a=e.backend_util.computeOutAndReduceShapes(t.shape,r),n=a[0],o=a[1],s=e.zeros(n,t.dtype),d=e.util.sizeFromShape(o),p=this.readSync(s.dataId),u=this.readSync(t.dataId),h=0;h<p.length;++h){for(var l=h*d,f=u[l],c=0;c<d;++c){var v=u[l+c];f=f&&v}p[h]=f}return s},v.prototype.any=function(t,r){i(t,"any"),e.backend_util.assertAxesAreInnerMostDims("any",r,t.rank);for(var a=e.backend_util.computeOutAndReduceShapes(t.shape,r),n=a[0],o=a[1],s=e.zeros(n,t.dtype),d=e.util.sizeFromShape(o),p=this.readSync(s.dataId),u=this.readSync(t.dataId),h=0;h<p.length;++h){for(var l=h*d,f=u[l],c=0;c<d;++c){var v=u[l+c];f=f||v}p[h]=f}return s},v.prototype.squaredDifference=function(t,e){return i([t,e],"squaredDifference"),this.broadcastedBinaryOp(t,e,t.dtype,(function(t,e){var r=t-e;return r*r}))},v.prototype.ceil=function(t){i(t,"ceil");for(var e=this.readSync(t.dataId),r=new Float32Array(e.length),a=0;a<e.length;++a)r[a]=Math.ceil(e[a]);return this.makeOutput(r,t.shape,"float32")},v.prototype.floor=function(t){i(t,"floor");for(var e=this.readSync(t.dataId),r=new Float32Array(e.length),a=0;a<e.length;++a)r[a]=Math.floor(e[a]);return this.makeOutput(r,t.shape,"float32")},v.prototype.sign=function(t){i(t,"x");for(var e=this.readSync(t.dataId),r=new Float32Array(e.length),a=0;a<e.length;++a)e[a]<0?r[a]=-1:e[a]>0?r[a]=1:r[a]=0;return this.makeOutput(r,t.shape,"float32")},v.prototype.isNaN=function(t){i(t,"x");for(var e=this.readSync(t.dataId),r=new Uint8Array(e.length),a=0;a<e.length;++a)Number.isNaN(e[a])&&(r[a]=1);return this.makeOutput(r,t.shape,"bool")},v.prototype.isInf=function(t){i(t,"x");for(var e=this.readSync(t.dataId),r=new Uint8Array(e.length),a=0;a<e.length;++a)Math.abs(e[a])===1/0&&(r[a]=1);return this.makeOutput(r,t.shape,"bool")},v.prototype.isFinite=function(t){i(t,"x");for(var e=this.readSync(t.dataId),r=new Uint8Array(e.length),a=0;a<e.length;++a)Number.isFinite(e[a])&&(r[a]=1);return this.makeOutput(r,t.shape,"bool")},v.prototype.round=function(t){i(t,"round");for(var e=this.readSync(t.dataId),r=new Float32Array(e.length),a=0;a<e.length;++a){var n=Math.floor(e[a]);e[a]-n<.5?r[a]=Math.floor(e[a]):e[a]-n>.5?r[a]=Math.ceil(e[a]):r[a]=n%2==0?n:n+1}return this.makeOutput(r,t.shape,"float32")},v.prototype.exp=function(t){i(t,"exp");for(var e=this.readSync(t.dataId),r=new Float32Array(e.length),a=0;a<e.length;++a)r[a]=Math.exp(e[a]);return this.makeOutput(r,t.shape,"float32")},v.prototype.expm1=function(t){i(t,"expm1");for(var e=this.readSync(t.dataId),r=new Float32Array(e.length),a=0;a<e.length;++a)r[a]=Math.expm1(e[a]);return this.makeOutput(r,t.shape,"float32")},v.prototype.log=function(t){i(t,"log");for(var e=this.readSync(t.dataId),r=new Float32Array(e.length),a=0;a<e.length;++a){var n=e[a];r[a]=Math.log(n)}return this.makeOutput(r,t.shape,"float32")},v.prototype.log1p=function(t){i(t,"log1p");for(var e=this.readSync(t.dataId),r=new Float32Array(e.length),a=0;a<e.length;++a){var n=e[a];r[a]=Math.log1p(n)}return this.makeOutput(r,t.shape,"float32")},v.prototype.sqrt=function(t){i(t,"sqrt");for(var e=this.readSync(t.dataId),r=new Float32Array(e.length),a=0;a<e.length;++a){var n=e[a];r[a]=Math.sqrt(n)}return this.makeOutput(r,t.shape,"float32")},v.prototype.rsqrt=function(t){i(t,"rsqrt");for(var e=this.readSync(t.dataId),r=new Float32Array(e.length),a=0;a<e.length;++a){var n=e[a];r[a]=1/Math.sqrt(n)}return this.makeOutput(r,t.shape,"float32")},v.prototype.reciprocal=function(t){i(t,"reciprocal");for(var e=this.readSync(t.dataId),r=new Float32Array(e.length),a=0;a<e.length;++a)r[a]=1/e[a];return this.makeOutput(r,t.shape,"float32")},v.prototype.linear=function(t){return t},v.prototype.relu=function(t){i(t,"relu");for(var r=e.zeros(t.shape,t.dtype),a=this.readSync(r.dataId),n=this.readSync(t.dataId),o=0;o<n.length;++o)a[o]=Math.max(0,n[o]);return r},v.prototype.relu6=function(t){i(t,"relu");for(var r=e.zeros(t.shape,t.dtype),a=this.readSync(r.dataId),n=this.readSync(t.dataId),o=0;o<n.length;++o)a[o]=Math.min(Math.max(0,n[o]),6);return r},v.prototype.prelu=function(t,e){return i([t,e],"prelu"),this.broadcastedBinaryOp(t,e,t.dtype,(function(t,e){return t<0?e*t:t}))},v.prototype.elu=function(t){i(t,"elu");for(var e=new Float32Array(t.size),r=this.readSync(t.dataId),a=0;a<r.length;++a){var n=r[a];e[a]=n>=0?n:Math.exp(n)-1}return this.makeOutput(e,t.shape,"float32")},v.prototype.eluDer=function(t,e){i([t,e],"eluDer");for(var r=new Float32Array(e.size),a=this.readSync(e.dataId),n=this.readSync(t.dataId),o=0;o<a.length;++o){var s=a[o];r[o]=s>=1?n[o]:n[o]*(s+1)}return this.makeOutput(r,e.shape,"float32")},v.prototype.selu=function(t){i(t,"selu");for(var r=e.backend_util.SELU_SCALEALPHA,a=e.backend_util.SELU_SCALE,n=new Float32Array(t.size),o=this.readSync(t.dataId),s=0;s<o.length;++s){var d=o[s];n[s]=d>=0?a*d:r*(Math.exp(d)-1)}return this.makeOutput(n,t.shape,"float32")},v.prototype.clip=function(t,e,r){i(t,"clip");for(var a=new Float32Array(t.size),n=this.readSync(t.dataId),o=0;o<n.length;++o){var s=n[o];a[o]=s>r?r:s<e?e:s}return this.makeOutput(a,t.shape,t.dtype)},v.prototype.abs=function(t){for(var e=new Float32Array(t.size),r=this.readSync(t.dataId),a=0;a<r.length;++a)e[a]=Math.abs(r[a]);return this.makeOutput(e,t.shape,"float32")},v.prototype.complexAbs=function(t){for(var e=new Float32Array(t.size),r=this.readSync(t.dataId),a=0;a<t.size;++a){var n=r[2*a],o=r[2*a+1];e[a]=Math.hypot(n,o)}return this.makeOutput(e,t.shape,"float32")},v.prototype.int=function(t){i(t,"int");for(var e=new Int32Array(t.size),r=this.readSync(t.dataId),a=0;a<r.length;++a)e[a]=r[a];return this.makeOutput(e,t.shape,"int32")},v.prototype.sigmoid=function(t){i(t,"sigmoid");for(var e=new Float32Array(t.size),r=this.readSync(t.dataId),a=0;a<r.length;++a)e[a]=1/(1+Math.exp(-r[a]));return this.makeOutput(e,t.shape,"float32")},v.prototype.softplus=function(t){i(t,"softplus");for(var e=Math.log(1.1920928955078125e-7)+2,r=new Float32Array(t.size),a=this.readSync(t.dataId),n=0;n<a.length;++n){var o=a[n]>-e,s=a[n]<e,d=Math.exp(a[n]),p=void 0;p=s?d:o?a[n]:Math.log(1+d),r[n]=p}return this.makeOutput(r,t.shape,"float32")},v.prototype.sin=function(t){i(t,"sin");for(var e=new Float32Array(t.size),r=this.readSync(t.dataId),a=0;a<r.length;++a)e[a]=Math.sin(r[a]);return this.makeOutput(e,t.shape,"float32")},v.prototype.tan=function(t){i(t,"tan");for(var e=new Float32Array(t.size),r=this.readSync(t.dataId),a=0;a<r.length;++a)e[a]=Math.tan(r[a]);return this.makeOutput(e,t.shape,"float32")},v.prototype.asin=function(t){i(t,"asin");for(var e=new Float32Array(t.size),r=this.readSync(t.dataId),a=0;a<r.length;++a)e[a]=Math.asin(r[a]);return this.makeOutput(e,t.shape,"float32")},v.prototype.acos=function(t){i(t,"acos");for(var e=new Float32Array(t.size),r=this.readSync(t.dataId),a=0;a<r.length;++a)e[a]=Math.acos(r[a]);return this.makeOutput(e,t.shape,"float32")},v.prototype.atan=function(t){i(t,"atan");for(var e=new Float32Array(t.size),r=this.readSync(t.dataId),a=0;a<r.length;++a)e[a]=Math.atan(r[a]);return this.makeOutput(e,t.shape,"float32")},v.prototype.atan2=function(t,e){return i([t,e],"atan2"),this.broadcastedBinaryOp(t,e,t.dtype,(function(t,e){return Math.atan2(t,e)}))},v.prototype.sinh=function(t){i(t,"sinh");for(var e=new Float32Array(t.size),r=this.readSync(t.dataId),a=0;a<r.length;++a)e[a]=Math.sinh(r[a]);return this.makeOutput(e,t.shape,"float32")},v.prototype.cosh=function(t){i(t,"cosh");for(var e=new Float32Array(t.size),r=this.readSync(t.dataId),a=0;a<r.length;++a)e[a]=Math.cosh(r[a]);return this.makeOutput(e,t.shape,"float32")},v.prototype.tanh=function(t){i(t,"tanh");for(var r=new Float32Array(t.size),a=this.readSync(t.dataId),n=0;n<a.length;++n)r[n]=e.util.tanh(a[n]);return this.makeOutput(r,t.shape,"float32")},v.prototype.asinh=function(t){i(t,"asinh");for(var e=new Float32Array(t.size),r=this.readSync(t.dataId),a=0;a<r.length;++a)e[a]=Math.asinh(r[a]);return this.makeOutput(e,t.shape,"float32")},v.prototype.acosh=function(t){i(t,"acosh");for(var e=new Float32Array(t.size),r=this.readSync(t.dataId),a=0;a<r.length;++a)e[a]=Math.acosh(r[a]);return this.makeOutput(e,t.shape,"float32")},v.prototype.atanh=function(t){i(t,"atanh");for(var e=new Float32Array(t.size),r=this.readSync(t.dataId),a=0;a<r.length;++a)e[a]=Math.atanh(r[a]);return this.makeOutput(e,t.shape,"float32")},v.prototype.erf=function(t){i(t,"erf");for(var r=new Float32Array(t.size),a=this.readSync(t.dataId),n=e.backend_util.ERF_P,o=e.backend_util.ERF_A1,s=e.backend_util.ERF_A2,d=e.backend_util.ERF_A3,p=e.backend_util.ERF_A4,u=e.backend_util.ERF_A5,h=0;h<a.length;++h){var l=Math.sign(a[h]),f=Math.abs(a[h]),c=1/(1+n*f);r[h]=l*(1-((((u*c+p)*c+d)*c+s)*c+o)*c*Math.exp(-f*f))}return this.makeOutput(r,t.shape,"float32")},v.prototype.step=function(t,e){void 0===e&&(e=0),i(t,"step");for(var r=new Float32Array(t.size),a=this.readSync(t.dataId),n=0;n<a.length;++n){var o=a[n];isNaN(o)?r[n]=NaN:r[n]=o>0?1:e}return this.makeOutput(r,t.shape,"float32")},v.prototype.fusedConv2d=function(t){var e=t.input,r=t.filter,a=t.convInfo,n=t.bias,o=t.activation,i=t.preluActivationWeights,s=this.conv2d(e,r,a);return n&&(s=this.add(s,n)),o&&(s=c(this,s,o,i)),s},v.prototype.conv2d=function(t,r,a){i([t,r],"conv2d");for(var n=a.filterHeight,o=a.filterWidth,s=a.dilationHeight,d=a.dilationWidth,p=a.padInfo.left,u=a.padInfo.top,h="channelsLast"===a.dataFormat,l=e.buffer(a.outShape,t.dtype),f=t.strides[0],c=h?t.strides[1]:t.strides[2],v=h?t.strides[2]:1,y=h?1:t.strides[1],m=l.strides[0],g=h?l.strides[1]:l.strides[2],I=h?l.strides[2]:1,S=h?1:l.strides[1],b=this.readSync(t.dataId),k=this.readSync(r.dataId),x=l.values,M=0;M<a.batchSize;++M)for(var F=M*f,A=M*m,T=0;T<a.outHeight;++T)for(var D=A+T*g,w=T*a.strideHeight-u,N=0;N<n;N++){var z=w+N*s;if(!(z<0||z>=a.inHeight))for(var W=N*r.strides[0],_=F+z*c,H=0;H<a.outWidth;++H)for(var O=D+H*I,C=H*a.strideWidth-p,B=0;B<o;B++){var E=C+B*d;if(!(E<0||E>=a.inWidth))for(var P=_+E*v,R=W+B*r.strides[1],q=0;q<a.inChannels;++q){for(var L=b[P+q*y],U=0;U<a.outChannels;++U)x[O+U*S]+=L*k[R+U];R+=a.outChannels}}}return l.toTensor()},v.prototype.conv3d=function(t,r,a){for(var n=a.filterDepth,o=a.filterHeight,i=a.filterWidth,s=a.dilationDepth,d=a.dilationHeight,p=a.dilationWidth,u=a.padInfo.front,h=a.padInfo.left,l=a.padInfo.top,f=e.buffer(a.outShape,t.dtype),c=this.readSync(t.dataId),v=this.readSync(r.dataId),y=f.values,m=0;m<a.batchSize;++m)for(var g=m*t.strides[0],I=m*f.strides[0],S=0;S<a.outDepth;++S)for(var b=I+S*f.strides[1],k=S*a.strideDepth-u,x=0;x<n;x++){var M=k+x*s;if(!(M<0||M>=a.inDepth))for(var F=x*r.strides[0],A=g+M*t.strides[1],T=0;T<a.outHeight;++T)for(var D=b+T*f.strides[2],w=T*a.strideHeight-l,N=0;N<o;N++){var z=w+N*d;if(!(z<0||z>=a.inHeight))for(var W=F+N*r.strides[1],_=A+z*t.strides[2],H=0;H<a.outWidth;++H)for(var O=D+H*a.outChannels,C=H*a.strideWidth-h,B=0;B<i;B++){var E=C+B*p;if(!(E<0||E>=a.inWidth))for(var P=W+B*r.strides[2],R=_+E*a.inChannels,q=P,L=0;L<a.inChannels;++L){for(var U=c[R+L],V=0;V<a.outChannels;++V)y[O+V]+=U*v[q+V];q+=a.outChannels}}}}return f.toTensor()},v.prototype.conv2dDerInput=function(t,r,a){i([t,r],"conv2dDerInput");for(var n=e.buffer(a.inShape,"float32"),o=n.values,s=this.readSync(t.dataId),d=this.readSync(r.dataId),p=r.strides,u=p[0],h=p[1],l=p[2],f=a.batchSize,c=a.filterHeight,v=a.filterWidth,y=a.inChannels,m=a.inHeight,g=a.inWidth,I=a.outChannels,S=a.outHeight,b=a.outWidth,k=a.strideHeight,x=a.strideWidth,M=a.dataFormat,F=c-1-a.padInfo.top,A=v-1-a.padInfo.left,T="channelsLast"===M,D=n.strides[0],w=T?n.strides[1]:n.strides[2],N=T?n.strides[2]:1,z=T?1:n.strides[1],W=t.strides[0],_=T?t.strides[1]:t.strides[2],H=T?t.strides[2]:1,O=T?1:t.strides[1],C=0;C<f;++C)for(var B=0;B<y;++B)for(var E=0;E<m;++E)for(var P=E-F,R=Math.max(0,Math.ceil(P/k)),q=Math.min(S,(c+P)/k),L=0;L<g;++L){for(var U=L-A,V=Math.max(0,Math.ceil(U/x)),G=Math.min(b,(v+U)/x),j=0,Y=R;Y<q;++Y)for(var K=Y*k-P,Z=V;Z<G;++Z)for(var J=W*C+_*Y+H*Z,Q=u*(c-1-K)+h*(v-1-(Z*x-U))+l*B,X=0;X<I;++X){j+=s[J+O*X]*d[Q+X]}o[D*C+w*E+N*L+z*B]=j}return n.toTensor()},v.prototype.conv3dDerInput=function(t,r,a){for(var n=e.buffer(a.inShape,"float32"),o=n.values,i=n.strides,s=i[0],d=i[1],p=i[2],u=i[3],h=this.readSync(t.dataId),l=t.strides,f=l[0],c=l[1],v=l[2],y=l[3],m=this.readSync(r.dataId),g=r.strides,I=g[0],S=g[1],b=g[2],k=g[3],x=a.batchSize,M=a.filterDepth,F=a.filterHeight,A=a.filterWidth,T=a.inChannels,D=a.inDepth,w=a.inHeight,N=a.inWidth,z=a.outChannels,W=a.outDepth,_=a.outHeight,H=a.outWidth,O=a.strideDepth,C=a.strideHeight,B=a.strideWidth,E=M-1-a.padInfo.front,P=F-1-a.padInfo.top,R=A-1-a.padInfo.left,q=0;q<x;++q)for(var L=0;L<T;++L)for(var U=0;U<D;++U)for(var V=U-E,G=Math.max(0,Math.ceil(V/O)),j=Math.min(W,(M+V)/O),Y=0;Y<w;++Y)for(var K=Y-P,Z=Math.max(0,Math.ceil(K/C)),J=Math.min(_,(F+K)/C),Q=0;Q<N;++Q){for(var X=Q-R,$=Math.max(0,Math.ceil(X/B)),tt=Math.min(H,(A+X)/B),et=0,rt=G;rt<j;++rt)for(var at=rt*O-V,nt=Z;nt<J;++nt)for(var ot=nt*C-K,it=$;it<tt;++it)for(var st=f*q+c*rt+v*nt+y*it,dt=I*(M-1-at)+S*(F-1-ot)+b*(A-1-(it*B-X))+k*L,pt=0;pt<z;++pt){et+=h[st+pt]*m[dt+pt]}o[s*q+d*U+p*Y+u*Q+L]=et}return n.toTensor()},v.prototype.conv2dDerFilter=function(t,r,a){i([t,r],"conv2dDerFilter");for(var n=a.strideHeight,o=a.strideWidth,s=a.filterHeight,d=a.filterWidth,p="channelsLast"===a.dataFormat,u=e.buffer(a.filterShape,"float32"),h=a.padInfo.left,l=a.padInfo.top,f=this.bufferSync(t),c=this.bufferSync(r),v=0;v<s;++v)for(var y=Math.max(0,Math.ceil((l-v)/n)),m=Math.min(a.outHeight,(a.inHeight+l-v)/n),g=0;g<d;++g)for(var I=Math.max(0,Math.ceil((h-g)/o)),S=Math.min(a.outWidth,(a.inWidth+h-g)/o),b=0;b<a.inChannels;++b)for(var k=0;k<a.outChannels;++k){for(var x=0,M=0;M<a.batchSize;++M)for(var F=y;F<m;++F)for(var A=v+F*n-l,T=I;T<S;++T){var D=g+T*o-h;x+=p?f.get(M,A,D,b)*c.get(M,F,T,k):f.get(M,b,A,D)*c.get(M,k,F,T)}u.set(x,v,g,b,k)}return u.toTensor()},v.prototype.conv3dDerFilter=function(t,r,a){for(var n=a.strideDepth,o=a.strideHeight,i=a.strideWidth,s=a.filterDepth,d=a.filterHeight,p=a.filterWidth,u=e.buffer(a.filterShape,"float32"),h=u.values,l=u.strides,f=l[0],c=l[1],v=l[2],y=l[3],m=this.readSync(r.dataId),g=r.strides,I=g[0],S=g[1],b=g[2],k=g[3],x=this.readSync(t.dataId),M=t.strides,F=M[0],A=M[1],T=M[2],D=M[3],w=a.padInfo.front,N=a.padInfo.left,z=a.padInfo.top,W=0;W<s;++W)for(var _=Math.max(0,Math.ceil((w-W)/n)),H=Math.min(a.outDepth,(a.inDepth+w-W)/n),O=W*f,C=0;C<d;++C)for(var B=Math.max(0,Math.ceil((z-C)/o)),E=Math.min(a.outHeight,(a.inHeight+z-C)/o),P=C*c+O,R=0;R<p;++R)for(var q=Math.max(0,Math.ceil((N-R)/i)),L=Math.min(a.outWidth,(a.inWidth+N-R)/i),U=R*v+P,V=0;V<a.inChannels;++V)for(var G=V*y+U,j=0;j<a.outChannels;++j){for(var Y=0,K=0;K<a.batchSize;++K)for(var Z=K*F,J=K*I,Q=_;Q<H;++Q)for(var X=(W+Q*n-w)*A+Z,$=Q*S+J,tt=B;tt<E;++tt)for(var et=(C+tt*o-z)*T+X,rt=tt*b+$,at=q;at<L;++at){var nt=at*k+rt;Y+=x[(R+at*i-N)*D+et+V]*m[nt+j]}h[G+j]=Y}return u.toTensor()},v.prototype.fusedDepthwiseConv2D=function(t){var e=t.input,r=t.filter,a=t.convInfo,n=t.bias,o=t.activation,i=t.preluActivationWeights,s=this.depthwiseConv2D(e,r,a);return n&&(s=this.add(s,n)),o&&(s=c(this,s,o,i)),s},v.prototype.depthwiseConv2D=function(t,r,a){i([t,r],"depthwiseConv2D");for(var n=a.filterHeight,o=a.filterWidth,s=a.dilationHeight,d=a.dilationWidth,p=a.padInfo.left,u=a.padInfo.top,h=a.outChannels/a.inChannels,l=e.buffer(a.outShape,t.dtype),f=this.readSync(t.dataId),c=this.readSync(r.dataId),v=l.values,y=0;y<a.batchSize;++y)for(var m=y*t.strides[0],g=y*l.strides[0],I=0;I<a.outHeight;++I)for(var S=g+I*l.strides[1],b=I*a.strideHeight-p,k=0;k<n;++k){var x=b+k*s;if(!(x<0||x>=a.inHeight))for(var M=k*r.strides[0],F=m+x*t.strides[1],A=0;A<a.outWidth;++A)for(var T=S+A*l.strides[2],D=A*a.strideWidth-u,w=0;w<o;++w){var N=D+w*d;if(!(N<0||N>=a.inWidth))for(var z=M+w*r.strides[1],W=F+N*a.inChannels,_=T,H=z,O=0;O<a.inChannels;++O){for(var C=f[W+O],B=0;B<h;++B)v[_+B]+=C*c[H+B];_+=h,H+=h}}}return l.toTensor()},v.prototype.depthwiseConv2DDerInput=function(t,r,a){i([t,r],"depthwiseConv2DDerInput");for(var n=e.buffer(a.inShape,"float32"),o=n.values,s=n.strides,d=s[0],p=s[1],u=s[2],h=this.readSync(t.dataId),l=t.strides,f=l[0],c=l[1],v=l[2],y=this.readSync(r.dataId),m=r.strides,g=m[0],I=m[1],S=m[2],b=a.batchSize,k=a.filterHeight,x=a.filterWidth,M=a.inChannels,F=a.inHeight,A=a.inWidth,T=a.outChannels,D=a.outHeight,w=a.outWidth,N=a.strideHeight,z=a.strideWidth,W=k-1-a.padInfo.top,_=x-1-a.padInfo.left,H=T/M,O=0;O<b;++O)for(var C=0;C<M;++C)for(var B=0;B<F;++B)for(var E=B-W,P=Math.max(0,Math.ceil(E/N)),R=Math.min(D,(k+E)/N),q=0;q<A;++q){for(var L=q-_,U=Math.max(0,Math.ceil(L/z)),V=Math.min(w,(x+L)/z),G=0,j=P;j<R;++j)for(var Y=j*N-E,K=U;K<V;++K)for(var Z=f*O+c*j+v*K,J=g*(k-1-Y)+I*(x-1-(K*z-L))+S*C,Q=0;Q<H;++Q){G+=h[Z+(C*H+Q)]*y[J+Q]}o[d*O+p*B+u*q+C]=G}return n.toTensor()},v.prototype.depthwiseConv2DDerFilter=function(t,r,a){i([t,r],"depthwiseConv2DDerFilter");for(var n=a.strideHeight,o=a.strideWidth,s=a.filterHeight,d=a.filterWidth,p=e.buffer(a.filterShape,"float32"),u=a.padInfo.left,h=a.padInfo.top,l=a.outChannels/a.inChannels,f=this.bufferSync(t),c=this.bufferSync(r),v=0;v<s;++v)for(var y=Math.max(0,Math.ceil((h-v)/n)),m=Math.min(a.outHeight,(a.inHeight+h-v)/n),g=0;g<d;++g)for(var I=Math.max(0,Math.ceil((u-g)/o)),S=Math.min(a.outWidth,(a.inWidth+u-g)/o),b=0;b<a.outChannels;++b){for(var k=Math.trunc(b/l),x=b%l,M=0,F=0;F<a.batchSize;++F)for(var A=y;A<m;++A)for(var T=v+A*n-h,D=I;D<S;++D){var w=g+D*o-u;M+=f.get(F,T,w,k)*c.get(F,A,D,b)}p.set(M,v,g,k,x)}return p.toTensor()},v.prototype.tile=function(t,e){return i(t,"tile"),h(this.bufferSync(t),e)},v.prototype.gather=function(t,r,a){i([t,r],"gather");var n=t.shape.slice(),o=this.readSync(r.dataId);n[a]=o.length;for(var s=e.buffer(n,t.dtype),d=this.bufferSync(t),p=0;p<s.size;++p){var u=s.indexToLoc(p),h=u.slice();h[a]=o[u[a]];var l=d.locToIndex(h);s.values[p]=d.values[l]}return s.toTensor()},v.prototype.batchToSpaceND=function(t,r,a){i([t],"batchToSpaceND");var n=r.reduce((function(t,e){return t*e})),o=e.backend_util.getReshaped(t.shape,r,n),s=e.backend_util.getPermuted(o.length,r.length),d=e.backend_util.getReshapedPermuted(t.shape,r,n),p=e.backend_util.getSliceBeginCoords(a,r.length),u=e.backend_util.getSliceSize(d,a,r.length);return e.transpose(t.reshape(o),s).reshape(d).slice(p,u)},v.prototype.maxPool=function(t,e){return i(t,"maxPool"),s(this.readSync(t.dataId),t.shape,t.dtype,t.strides,e,"max").toTensor()},v.prototype.maxPoolBackprop=function(t,r,a,n){i([r,a],"maxPoolBackprop");for(var o=this.readSync(r.dataId),s=e.buffer(n.outShape,r.dtype,d(o,r.shape,r.dtype,n).values),p=n.strideHeight,u=n.strideWidth,h=n.dilationHeight,l=n.dilationWidth,f=n.effectiveFilterHeight,c=n.effectiveFilterWidth,v=c-1-n.padInfo.left,y=f-1-n.padInfo.top,m=e.buffer(r.shape,"float32"),g=this.bufferSync(t),I=0;I<n.batchSize;++I)for(var S=0;S<n.inChannels;++S)for(var b=0;b<n.inHeight;++b)for(var k=0;k<n.inWidth;++k){for(var x=b-y,M=k-v,F=0,A=0;A<f;A+=h){var T=(x+A)/p;if(!(T<0||T>=n.outHeight||Math.floor(T)!==T))for(var D=0;D<c;D+=l){var w=(M+D)/u;if(!(w<0||w>=n.outWidth||Math.floor(w)!==w)){var N=f*c-1-s.get(I,T,w,S)===A*c+D?1:0;if(0!==N)F+=g.get(I,T,w,S)*N}}}m.set(F,I,b,k,S)}return m.toTensor()},v.prototype.avgPoolBackprop=function(t,r,a){i([t,r],"avgPoolBackprop");for(var n=a.strideHeight,o=a.strideWidth,s=a.filterHeight,d=a.filterWidth,p=a.dilationHeight,u=a.dilationWidth,h=a.effectiveFilterHeight,l=a.effectiveFilterWidth,f=l-1-a.padInfo.left,c=h-1-a.padInfo.top,v=e.buffer(r.shape,"float32"),y=1/(s*d),m=this.bufferSync(t),g=0;g<a.batchSize;++g)for(var I=0;I<a.inChannels;++I)for(var S=0;S<a.inHeight;++S)for(var b=0;b<a.inWidth;++b){for(var k=S-c,x=b-f,M=0,F=0;F<h;F+=p){var A=(k+F)/n;if(!(A<0||A>=a.outHeight||Math.floor(A)!==A))for(var T=0;T<l;T+=u){var D=(x+T)/o;if(!(D<0||D>=a.outWidth||Math.floor(D)!==D))M+=m.get(g,A,D,I)}}v.set(M*y,g,S,b,I)}return v.toTensor()},v.prototype.pool3d=function(t,r,a){i(t,"pool3d");for(var n=r.strideDepth,o=r.strideHeight,s=r.strideWidth,d=r.dilationDepth,p=r.dilationHeight,u=r.dilationWidth,h=r.effectiveFilterDepth,l=r.effectiveFilterHeight,f=r.effectiveFilterWidth,c=r.padInfo.front,v=r.padInfo.top,y=r.padInfo.left,m="max"===a?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY,g=this.readSync(t.dataId),I=e.buffer(r.outShape,t.dtype),S=I.values,b=r.outShape[1]*r.outShape[2]*r.outShape[3]*r.outShape[4],k=r.outShape[2]*r.outShape[3]*r.outShape[4],x=r.outShape[3]*r.outShape[4],M=r.outShape[4],F=0;F<r.batchSize;++F)for(var A=F*b,T=F*t.strides[0],D=0;D<r.inChannels;++D)for(var w=0;w<r.outDepth;++w){for(var N=w*n-c,z=N;z<0;)z+=d;for(var W=Math.min(r.inDepth,h+N),_=A+w*k,H=0;H<r.outHeight;++H){for(var O=H*o-v,C=O;C<0;)C+=p;for(var B=Math.min(r.inHeight,l+O),E=_+H*x,P=0;P<r.outWidth;++P){for(var R=P*s-y,q=R;q<0;)q+=u;for(var L=Math.min(r.inWidth,f+R),U=E+P*M,V=m,G=0,j=0,Y=z;Y<W;Y+=d){for(var K=T+Y*t.strides[1],Z=C;Z<B;Z+=p){for(var J=K+Z*t.strides[2],Q=q;Q<L;Q+=u){var X=g[J+Q*t.strides[3]+D];if("max"===a&&X>V?V=X:"avg"===a&&(G+=X,j++),isNaN(V))break}if(isNaN(V))break}if(isNaN(V))break}S[U+D]="avg"===a?G/j:V}}}return I.toTensor()},v.prototype.avgPool3d=function(t,e){return i(t,"avgPool3d"),this.pool3d(t,e,"avg").toFloat()},v.prototype.avgPool3dBackprop=function(t,r,a){i([t,r],"avgPool3dBackprop");for(var n=a.strideDepth,o=a.strideHeight,s=a.strideWidth,d=a.filterDepth,p=a.filterHeight,u=a.filterWidth,h=a.dilationDepth,l=a.dilationHeight,f=a.dilationWidth,c=a.effectiveFilterDepth,v=a.effectiveFilterHeight,y=a.effectiveFilterWidth,m=c-1-a.padInfo.front,g=y-1-a.padInfo.left,I=v-1-a.padInfo.top,S=e.buffer(r.shape,"float32"),b=1/(d*p*u),k=this.bufferSync(t),x=0;x<a.batchSize;++x)for(var M=0;M<a.inChannels;++M)for(var F=0;F<a.inDepth;++F)for(var A=0;A<a.inHeight;++A)for(var T=0;T<a.inWidth;++T){for(var D=F-m,w=A-I,N=T-g,z=0,W=0;W<c;W+=h){var _=(D+W)/n;if(!(_<0||_>=a.outDepth||Math.floor(_)!==_))for(var H=0;H<v;H+=l){var O=(w+H)/o;if(!(O<0||O>=a.outHeight||Math.floor(O)!==O))for(var C=0;C<y;C+=f){var B=(N+C)/s;if(!(B<0||B>=a.outWidth||Math.floor(B)!==B))z+=k.get(x,_,O,B,M)}}}S.set(z*b,x,F,A,T,M)}return S.toTensor()},v.prototype.maxPool3d=function(t,e){return i(t,"maxPool3d"),this.pool3d(t,e,"max").toFloat()},v.prototype.maxPool3dPositions=function(t,r){for(var a=e.buffer(r.outShape,"int32"),n=r.strideDepth,o=r.strideHeight,i=r.strideWidth,s=r.dilationDepth,d=r.dilationHeight,p=r.dilationWidth,u=r.effectiveFilterDepth,h=r.effectiveFilterHeight,l=r.effectiveFilterWidth,f=r.padInfo.front,c=r.padInfo.top,v=r.padInfo.left,y=this.bufferSync(t),m=0;m<r.batchSize;++m)for(var g=0;g<r.inChannels;++g)for(var I=0;I<r.outDepth;++I){for(var S=I*n-f,b=S;b<0;)b+=s;for(var k=Math.min(r.inDepth,u+S),x=0;x<r.outHeight;++x){for(var M=x*o-c,F=M;F<0;)F+=d;for(var A=Math.min(r.inHeight,h+M),T=0;T<r.outWidth;++T){for(var D=T*i-v,w=D;w<0;)w+=p;for(var N=Math.min(r.inWidth,l+D),z=Number.NEGATIVE_INFINITY,W=-1,_=b;_<k;_+=s)for(var H=_-S,O=F;O<A;O+=d)for(var C=O-M,B=w;B<N;B+=p){var E=B-D,P=y.get(m,_,O,B,g);P>=z&&(z=P,W=H*h*l+C*h+E)}a.set(W,m,I,x,T,g)}}}return a.toTensor()},v.prototype.maxPool3dBackprop=function(t,r,a,n){i([r,a],"maxPool3dBackprop");for(var o=this.maxPool3dPositions(r,n),s=n.strideDepth,d=n.strideHeight,p=n.strideWidth,u=n.dilationDepth,h=n.dilationHeight,l=n.dilationWidth,f=n.effectiveFilterDepth,c=n.effectiveFilterHeight,v=n.effectiveFilterWidth,y=f-1-n.padInfo.front,m=v-1-n.padInfo.left,g=c-1-n.padInfo.top,I=e.buffer(r.shape,"float32"),S=this.bufferSync(o),b=this.bufferSync(t),k=0;k<n.batchSize;++k)for(var x=0;x<n.inChannels;++x)for(var M=0;M<n.inDepth;++M)for(var F=0;F<n.inHeight;++F)for(var A=0;A<n.inWidth;++A){for(var T=M-y,D=F-g,w=A-m,N=0,z=0;z<f;z+=u){var W=(T+z)/s;if(!(W<0||W>=n.outDepth||Math.floor(W)!==W))for(var _=0;_<c;_+=h){var H=(D+_)/d;if(!(H<0||H>=n.outHeight||Math.floor(H)!==H))for(var O=0;O<v;O+=l){var C=(w+O)/p;if(!(C<0||C>=n.outWidth||Math.floor(C)!==C)){var B=f*c*v-1-S.get(k,W,H,C,x)===z*c*v+_*v+O?1:0;if(0!==B)N+=b.get(k,W,H,C,x)*B}}}}I.set(N,k,M,F,A,x)}return I.toTensor()},v.prototype.cast=function(t,r){return e.backend_util.castTensor(t,r,this)},v.prototype.avgPool=function(t,e){return i(t,"avgPool"),i(t,"maxPool"),s(this.readSync(t.dataId),t.shape,t.dtype,t.strides,e,"avg").toTensor().toFloat()},v.prototype.resizeBilinear=function(t,r,a,n){i(t,"resizeBilinear");for(var o=t.shape,s=o[0],d=o[1],p=o[2],u=o[3],h=this.readSync(t.dataId),l=new Float32Array(e.util.sizeFromShape([s,r,a,u])),f=[n&&r>1?d-1:d,n&&a>1?p-1:p],c=[n&&r>1?r-1:r,n&&a>1?a-1:a],v=0,y=f[0]/c[0],m=f[1]/c[1],g=0;g<s;g++)for(var I=0;I<r;I++)for(var S=y*I,b=Math.floor(S),k=S-b,x=Math.min(d-1,Math.ceil(S)),M=g*t.strides[0]+b*t.strides[1],F=g*t.strides[0]+x*t.strides[1],A=0;A<a;A++)for(var T=m*A,D=Math.floor(T),w=T-D,N=Math.min(p-1,Math.ceil(T)),z=M+D*t.strides[2],W=F+D*t.strides[2],_=M+N*t.strides[2],H=F+N*t.strides[2],O=0;O<u;O++){var C=h[z+O],B=h[W+O],E=C+(h[_+O]-C)*w,P=E+(B+(h[H+O]-B)*w-E)*k;l[v++]=P}return e.tensor(l,[s,r,a,u])},v.prototype.resizeBilinearBackprop=function(t,r,a){i([t,r],"resizeBilinearBackprop");for(var n=r.shape,o=n[0],s=n[1],d=n[2],p=n[3],u=t.shape,h=u[1],l=u[2],f=new Float32Array(o*s*d*p),c=[a&&h>1?s-1:s,a&&l>1?d-1:d],v=[a&&h>1?h-1:h,a&&l>1?l-1:l],y=c[0]/v[0],m=c[1]/v[1],g=this.readSync(t.dataId),I=0,S=0;S<o;S++)for(var b=S*r.strides[0],k=0;k<h;k++)for(var x=k*y,M=Math.floor(x),F=Math.min(Math.ceil(x),s-1),A=b+M*r.strides[1],T=b+F*r.strides[1],D=x-M,w=1-D,N=0;N<l;N++)for(var z=N*m,W=Math.floor(z),_=Math.min(Math.ceil(z),d-1),H=z-W,O=1-H,C=A+W*r.strides[2],B=A+_*r.strides[2],E=T+W*r.strides[2],P=T+_*r.strides[2],R=w*O,q=w*H,L=D*O,U=D*H,V=0;V<p;V++){var G=g[I++];f[C+V]+=G*R,f[B+V]+=G*q,f[E+V]+=G*L,f[P+V]+=G*U}return e.tensor4d(f,[o,d,s,p],r.dtype)},v.prototype.resizeNearestNeighbor=function(t,r,a,n){i(t,"resizeNearestNeighbor");for(var o=t.shape,s=o[0],d=o[1],p=o[2],u=o[3],h=this.readSync(t.dataId),l=new Float32Array(s*r*a*u),f=[n&&r>1?d-1:d,n&&a>1?p-1:p],c=[n&&r>1?r-1:r,n&&a>1?a-1:a],v=f[0]/c[0],y=f[1]/c[1],m=0,g=0;g<s;g++)for(var I=g*t.strides[0],S=0;S<r;S++)for(var b=v*S,k=I+Math.min(d-1,n?Math.round(b):Math.floor(b))*t.strides[1],x=0;x<a;x++)for(var M=y*x,F=k+Math.min(p-1,n?Math.round(M):Math.floor(M))*t.strides[2],A=0;A<u;A++){var T=h[F+A];l[m++]=T}return e.tensor(l,[s,r,a,u],t.dtype)},v.prototype.resizeNearestNeighborBackprop=function(t,r,a){i([t,r],"resizeNearestNeighborBackprop");for(var n=r.shape,o=n[0],s=n[1],d=n[2],p=n[3],u=t.shape,h=u[1],l=u[2],f=new Float32Array(o*s*d*p),c=this.readSync(t.dataId),v=[a&&h>1?s-1:s,a&&l>1?d-1:d],y=[a&&h>1?h-1:h,a&&l>1?l-1:l],m=v[0]/y[0],g=v[1]/y[1],I=1/m,S=1/g,b=2*Math.ceil(I)+2,k=2*Math.ceil(S)+2,x=0;x<o;x++)for(var M=x*r.strides[0],F=0;F<s;F++)for(var A=M+F*r.strides[1],T=Math.floor(F*I),D=Math.floor(T-b/2),w=0;w<d;w++)for(var N=A+w*r.strides[2],z=Math.floor(w*S),W=Math.floor(z-k/2),_=0;_<p;_++){for(var H=0,O=0;O<b;O++){var C=O+D;if(!(C<0||C>=h)){var B=M+C*t.strides[1],E=C*m;if(F===Math.min(s-1,a?Math.round(E):Math.floor(E)))for(var P=0;P<k;P++){var R=P+W;if(!(R<0||R>=l)){var q=B+R*t.strides[2],L=R*g;w===Math.min(d-1,a?Math.round(L):Math.floor(L))&&(H+=c[q+_])}}}}f[N+_]=H}return e.tensor4d(f,r.shape,r.dtype)},v.prototype.batchNorm=function(t,r,a,n,o,s){i([t,r,a,o,n],"batchNorm");for(var d=this.readSync(t.dataId),p=this.readSync(r.dataId),u=this.readSync(a.dataId),h=o?this.readSync(o.dataId):new Float32Array([1]),l=n?this.readSync(n.dataId):new Float32Array([0]),f=new Float32Array(d.length),c=l.length,v=h.length,y=u.length,m=p.length,g=0,I=0,S=0,b=0,k=0;k<d.length;++k)f[k]=l[g++]+(d[k]-p[I++])*h[S++]/Math.sqrt(u[b++]+s),g>=c&&(g=0),I>=m&&(I=0),S>=v&&(S=0),b>=y&&(b=0);return e.tensor4d(f,t.shape)},v.prototype.localResponseNormalization4D=function(t,r,a,n,o){i(t,"localResponseNormalization4D");var s=t.shape[3],d=s-1,p=this.readSync(t.dataId),u=t.size,h=new Float32Array(u);function l(t){for(var e=t%s,a=t-e+Math.max(0,e-r),n=t-e+Math.min(e+r,d),o=0;a<=n;a++){var i=p[a];o+=i*i}return o}for(var f=0;f<u;f++){var c=l(f),v=p[f]*Math.pow(a+n*c,-o);h[f]=v}return e.tensor4d(h,t.shape)},v.prototype.LRNGrad=function(t,r,a,n,o,s,d){i(t,"LRNGrad");for(var p=t.shape[3],u=this.readSync(t.dataId),h=this.readSync(r.dataId),l=this.readSync(a.dataId),f=new Float32Array(t.size),c=t.size,v=0;v<c;v++){for(var y=v%p,m=v-y+Math.max(0,y-n),g=v-y+Math.min(p,y+n+1),I=0,S=m;S<g;S++)I+=Math.pow(h[S],2);I=s*I+o;for(S=m;S<g;S++){var b=-2*s*d*h[S]*l[v]/I;v===S&&(b+=Math.pow(I,-d)),b*=u[v],f[S]+=b}}return e.tensor4d(f,t.shape)},v.prototype.multinomial=function(t,a,n,o){i(t,"multinomial");for(var s=a?t:e.softmax(t),d=s.shape[0],p=s.shape[1],u=e.zeros([d,n],"int32"),h=this.readSync(u.dataId),l=this.readSync(s.dataId),f=0;f<d;++f){var c=f*p,v=new Float32Array(p-1);v[0]=l[c];for(var y=1;y<v.length;++y)v[y]=v[y-1]+l[c+y];for(var m=r.alea(o.toString()),g=f*n,I=0;I<n;++I){var S=m();h[g+I]=v.length;for(var b=0;b<v.length;b++)if(S<v[b]){h[g+I]=b;break}}}return u},v.prototype.oneHot=function(t,r,a,n){i(t,"oneHot");var o=new Float32Array(t.size*r);o.fill(n);for(var s=this.readSync(t.dataId),d=0;d<t.size;++d)s[d]>=0&&s[d]<r&&(o[d*r+s[d]]=a);return e.tensor2d(o,[t.size,r],"int32")},v.prototype.nonMaxSuppression=function(t,e,r,a,n){i(t,"nonMaxSuppression");var o=this.readSync(t.dataId),s=this.readSync(e.dataId);return p(o,s,r,a,n)},v.prototype.fft=function(t){return this.fftBatch(t,!1)},v.prototype.ifft=function(t){return this.fftBatch(t,!0)},v.prototype.fftBatch=function(t,r){for(var a=t.shape[0],n=t.shape[1],o=e.buffer(t.shape,"float32"),i=e.buffer(t.shape,"float32"),s=e.real(t).as2D(a,n),d=e.imag(t).as2D(a,n),p=0;p<a;p++)for(var u=s.slice([p,0],[1,n]),h=d.slice([p,0],[1,n]),l=e.complex(u,h),f=this.readSync(this.fftImpl(l,r).dataId),c=0;c<n;c++){var v=e.backend_util.getComplexWithIndex(f,c);o.values[p*n+c]=v.real,i.values[p*n+c]=v.imag}return e.complex(o.toTensor(),i.toTensor()).as2D(a,n)},v.prototype.fftImpl=function(t,r){var a=t.as1D(),n=a.size;if(this.isExponentOf2(n)){var o=this.fftRadix2(a,n,r).as2D(t.shape[0],t.shape[1]);return r&&(o=e.complex(e.real(o).div(e.scalar(n)),e.imag(o).div(e.scalar(n)))),o}var i=this.readSync(t.dataId),s=this.fourierTransformByMatmul(i,n,r),d=e.backend_util.splitRealAndImagArrays(s);return e.complex(d.real,d.imag).as2D(t.shape[0],t.shape[1])},v.prototype.isExponentOf2=function(t){return 0==(t&t-1)},v.prototype.fftRadix2=function(t,r,a){if(1===r)return t;var n=this.readSync(t.dataId),o=r/2,i=e.backend_util.complexWithEvenIndex(n),s=e.complex(i.real,i.imag).as1D(),d=e.backend_util.complexWithOddIndex(n),p=e.complex(d.real,d.imag).as1D();s=this.fftRadix2(s,o,a),p=this.fftRadix2(p,o,a);var u=e.backend_util.exponents(r,a),h=e.complex(u.real,u.imag).mul(p),l=s.add(h),f=s.sub(h),c=e.real(l).concat(e.real(f)),v=e.imag(l).concat(e.imag(f));return e.complex(c,v).as1D()},v.prototype.fourierTransformByMatmul=function(t,r,a){for(var n=new Float32Array(2*r),o=0;o<r;o++){for(var i=0,s=0,d=0;d<r;d++){var p=e.backend_util.exponent(o*d,r,a),u=e.backend_util.getComplexWithIndex(t,d);i+=u.real*p.real-u.imag*p.imag,s+=u.real*p.imag+u.imag*p.real}a&&(i/=r,s/=r),e.backend_util.assignToTypedArray(n,i,s,o)}return n},v.prototype.depthToSpace=function(t,r,a){e.util.assert("NHWC"===a,(function(){return"Only NHWC dataFormat supported on CPU for depthToSpace. Got "+a})),e.util.assert(r>1,(function(){return"blockSize should be > 1 for depthToSpace, but was: "+r}));for(var n=t.shape[0],o=t.shape[1],i=t.shape[2],s=t.shape[3],d=o*r,p=i*r,u=s/(r*r),h=this.readSync(t.dataId),l=new Float32Array(n*d*p*u),f=0,c=0;c<n;++c)for(var v=0;v<d;++v)for(var y=Math.floor(v/r),m=v%r,g=0;g<p;++g)for(var I=Math.floor(g/r),S=(m*r+g%r)*u,b=0;b<u;++b){var k=b+S+s*(I+i*(y+o*c));l[f++]=h[k]}return e.tensor4d(l,[n,d,p,u])},v.prototype.broadcastedBinaryOp=function(t,r,a,n){var o=e.backend_util.assertAndGetBroadcastShape(t.shape,r.shape),i=e.buffer(o,a),s=this.readSync(t.dataId),d=this.readSync(r.dataId),p=e.backend_util.getBroadcastDims(t.shape,o),u=e.backend_util.getBroadcastDims(r.shape,o),h=i.values;if(p.length+u.length===0)for(var l=0;l<h.length;++l)h[l]=n(s[l%s.length],d[l%d.length]);else{var f=this.bufferSync(t),c=this.bufferSync(r),v=function(e){var a=i.indexToLoc(e),o=a.slice(-t.rank);p.forEach((function(t){return o[t]=0}));var l=f.locToIndex(o),v=a.slice(-r.rank);u.forEach((function(t){return v[t]=0}));var y=c.locToIndex(v);h[e]=n(s[l],d[y])};for(l=0;l<h.length;++l)v(l)}return i.toTensor()},v.prototype.broadcastedBinaryComplexOp=function(t,r,a){var n=e.backend_util.assertAndGetBroadcastShape(t.shape,r.shape),o=e.buffer(n,"float32"),i=e.buffer(n,"float32"),s=this.readSync(t.dataId),d=this.readSync(r.dataId),p=e.backend_util.getBroadcastDims(t.shape,n),u=e.backend_util.getBroadcastDims(r.shape,n),h=o.values,l=i.values;if(p.length+u.length===0)for(var f=0;f<h.length;f++){var c=f%s.length,v=f%d.length,y=a(s[2*c],s[2*c+1],d[2*v],d[2*v+1]);h[f]=y.real,l[f]=y.imag}else{var m=this.bufferSync(this.data.get(t.dataId).complexTensors.real),g=this.bufferSync(this.data.get(r.dataId).complexTensors.real),I=function(e){var n=o.indexToLoc(e),i=n.slice(-t.rank);p.forEach((function(t){return i[t]=0}));var f=m.locToIndex(i),c=n.slice(-r.rank);u.forEach((function(t){return c[t]=0}));var v=g.locToIndex(c),y=a(s[2*f],s[2*f+1],d[2*v],d[2*v+1]);h[e]=y.real,l[e]=y.imag};for(f=0;f<h.length;f++)I(f)}return this.complex(o.toTensor(),i.toTensor())},v.prototype.split=function(t,e,r){return u(t,e,r)},v.prototype.dispose=function(){},v.prototype.floatPrecision=function(){return 32},v.prototype.epsilon=function(){return t.prototype.epsilon.call(this)},v.prototype.cropAndResize=function(t,r,a,n,o,i){for(var s=t.shape,d=s[0],p=s[1],u=s[2],h=s[3],l=r.shape[0],f=n[0],c=n[1],v=e.buffer([l,f,c,h],"float32"),y=this.readSync(r.dataId),m=this.readSync(a.dataId),g=this.readSync(t.dataId),I=t.strides,S=v.strides,b=0;b<l;b++){var k=4*b,x=y[k],M=y[k+1],F=y[k+2],A=y[k+3],T=m[b];if(!(T>=d))for(var D=f>1?(F-x)*(p-1)/(f-1):0,w=c>1?(A-M)*(u-1)/(c-1):0,N=0;N<f;N++){var z=f>1?x*(p-1)+N*D:.5*(x+F)*(p-1);if(z<0||z>p-1)for(var W=0;W<c;W++)for(var _=0;_<h;_++){var H=_+W*S[2]+N*S[1]+b*S[0];v.values[H]=i}else if("bilinear"===o){var O=Math.floor(z),C=Math.ceil(z),B=z-O;for(W=0;W<c;W++){if((j=c>1?M*(u-1)+W*w:.5*(M+A)*(u-1))<0||j>u-1)for(_=0;_<h;_++){H=_+W*S[2]+N*S[1]+b*S[0];v.values[H]=i}else{var E=Math.floor(j),P=Math.ceil(j),R=j-E;for(_=0;_<h;_++){var q=g[H=_+E*I[2]+O*I[1]+T*I[0]],L=g[H=_+P*I[2]+O*I[1]+T*I[0]],U=g[H=_+E*I[2]+C*I[1]+T*I[0]],V=q+(L-q)*R,G=U+(g[H=_+P*I[2]+C*I[1]+T*I[0]]-U)*R;H=_+W*S[2]+N*S[1]+b*S[0],v.values[H]=V+(G-V)*B}}}}else for(W=0;W<c;++W){var j;if((j=c>1?M*(u-1)+W*w:.5*(M+A)*(u-1))<0||j>u-1)for(_=0;_<h;_++){H=_+W*S[2]+N*S[1]+b*S[0];v.values[H]=i}else{var Y=Math.round(j),K=Math.round(z);for(_=0;_<h;_++){var Z=_+Y*I[2]+K*I[1]+T*I[0],J=_+W*S[2]+N*S[1]+b*S[0];v.values[J]=g[Z]}}}}}return v.toTensor()},v.prototype.sparseToDense=function(t,r,a,n){var o=e.backend_util.calculateShapes(r,t,a),i=o.sliceRank,s=o.numUpdates,d=o.sliceSize,p=o.strides,u=o.outputSize;return this.scatter(t,r,a,u,d,s,i,p,n,!1)},v.prototype.gatherND=function(t,r){var a=r.shape,n=a[a.length-1],o=e.backend_util.prepareAndValidate(t,r),i=o[0],s=o[1],d=o[2],p=o[3];if(0===s)return e.tensor([],i,t.dtype);for(var u=new e.TensorBuffer([s,d],t.dtype),h=this.readSync(r.dataId),l=this.readSync(t.dataId),f=0;f<s;f++){for(var c=[],v=0,y=0;y<n;y++){var m=h[f*n+y];v+=m*p[y],c.push(m)}if(v<0||v>=t.size/d)throw new Error("Invalid indices: "+c+" does not index into "+t.shape);for(var g=0;g<d;g++)u.values[f*d+g]=l[v*d+g]}return u.toTensor().reshape(i)},v.prototype.scatterND=function(t,r,a){var n=e.backend_util.calculateShapes(r,t,a),o=n.sliceRank,i=n.numUpdates,s=n.sliceSize,d=n.strides,p=n.outputSize,u=e.scalar(0);return this.scatter(t,r,a,p,s,i,o,d,u,!0)},v.prototype.fill=function(t,r,a){a=a||e.util.inferDtype(r);var n=e.util.getArrayFromDType(a,e.util.sizeFromShape(t));return n.fill(r),e.engine().makeTensor(n,t,a,this)},v.prototype.onesLike=function(t){if("string"===t.dtype)throw new Error("onesLike is not supported for string tensors");return this.fill(t.shape,1,t.dtype)},v.prototype.zerosLike=function(t){var r=e.util.getArrayFromDType(t.dtype,e.util.sizeFromShape(t.shape));return this.makeOutput(r,t.shape,t.dtype)},v.prototype.linspace=function(t,r,a){return e.backend_util.linspaceImpl(t,r,a)},v.prototype.scatter=function(t,r,a,n,o,i,s,d,p,u){var h=[n/o,o],l=this.readSync(t.dataId),f=this.readSync(r.dataId);if(0===n)return e.tensor([],a,r.dtype);var c=new e.TensorBuffer(h,r.dtype);c.values.fill(this.readSync(p.dataId)[0]);for(var v=0;v<i;v++){for(var y=[],m=0,g=0;g<s;g++){var I=l[v*s+g];y.push(I),m+=I*d[g]}if(m<0||m>=n/o)throw new Error("Invalid indices: "+y+" does not index into "+a);for(var S=0;S<o;S++)u?c.values[m*o+S]+=f[v*o+S]:c.values[m*o+S]=0===r.rank?f[0]:f[v*o+S]}return c.toTensor().reshape(a)},v}(e.KernelBackend);function y(t,r,a,n){for(var o=e.util.getTypedArrayFromDType(n,e.util.sizeFromShape(a)),i=0;i<o.length;++i){for(var s=i*r,d=t[s],p=0;p<r;++p){var u=t[s+p];u>d&&(d=u)}o[i]=d}return o}function m(t,r,a,n,o){for(var i=r.length,s=e.util.sizeFromShape(r),d=e.util.computeStrides(r),p=e.util.computeStrides(o),u=e.util.getTypedArrayFromDType(a,e.util.sizeFromShape(o)),h=0;h<s;++h){for(var l=e.util.indexToLoc(h,i,d),f=new Array(l.length),c=0;c<f.length;c++)f[c]=l[n[c]];u[e.util.locToIndex(f,i,p)]=t[h]}return u}var g={__proto__:null,maxImpl:y,transposeImpl:m};e.registerBackend("cpu",(function(){return new v}),1);var I={kernelName:e.Cos,backendName:"cpu",kernelFunc:function(t){var r=t.inputs,a=t.backend,n=r.x,o=a;i(n,"cos");for(var s=o.data.get(n.dataId).values,d=e.util.sizeFromShape(n.shape),p=new Float32Array(d),u=0;u<d;++u)p[u]=Math.cos(s[u]);return{dataId:o.write(p,n.shape,n.dtype),shape:n.shape,dtype:n.dtype}}},S={kernelName:e.Dilation2D,backendName:"cpu",kernelFunc:function(t){for(var r=t.inputs,a=t.backend,n=t.attrs,o=r,i=o.x,s=o.filter,d=n,p=d.strides,u=d.pad,h=d.dilations,l=a,f=l.data.get(i.dataId).values,c=i.shape.length,v=l.data.get(s.dataId).values,y=s.shape.length,m=e.backend_util.computeDilation2DInfo(i.shape,s.shape,p,u,"NHWC",h),g=m.batchSize,I=m.inHeight,S=m.inWidth,b=m.inChannels,k=m.outHeight,x=m.outWidth,M=m.padInfo,F=m.strideHeight,A=m.strideWidth,T=m.filterHeight,D=m.filterWidth,w=m.dilationHeight,N=m.dilationWidth,z=m.outShape,W=e.util.sizeFromShape(z),_=z.length,H=e.util.getArrayFromDType(i.dtype,W),O=0;O<g;++O)for(var C=0;C<k;++C)for(var B=C*F-M.top,E=0;E<x;++E)for(var P=E*A-M.left,R=0;R<b;++R){for(var q=Number.MIN_SAFE_INTEGER,L=0;L<T;++L){var U=B+L*w;if(U>=0&&U<I)for(var V=0;V<D;++V){var G=P+V*N;if(G>=0&&G<S){var j=e.util.locToIndex([O,U,G,R],c,e.util.computeStrides(i.shape)),Y=e.util.locToIndex([L,V,R],y,e.util.computeStrides(s.shape)),K=f[j]+v[Y];K>q&&(q=K)}}}H[e.util.locToIndex([O,C,E,R],_,e.util.computeStrides(z))]=q}return{dataId:l.write(e.util.toTypedArray(H,i.dtype),z,i.dtype),shape:z,dtype:i.dtype}}},b={kernelName:e.Dilation2DBackpropFilter,backendName:"cpu",kernelFunc:function(t){var r=t.inputs,a=t.backend,n=t.attrs,o=r,i=o.x,s=o.filter,d=o.dy,p=n,u=p.strides,h=p.pad,l=p.dilations,f=a,c=e.util.toNestedArray(i.shape,f.data.get(i.dataId).values),v=e.util.toNestedArray(s.shape,f.data.get(s.dataId).values),y=e.backend_util.computeDilation2DInfo(i.shape,s.shape,u,h,"NHWC",l),m=y.batchSize,g=y.inHeight,I=y.inWidth,S=y.inChannels,b=y.outHeight,k=y.outWidth,x=y.padInfo,M=y.strideHeight,F=y.strideWidth,A=y.filterHeight,T=y.filterWidth,D=y.dilationHeight,w=y.dilationWidth,N=y.outShape;e.util.assert(d.rank===N.length,(function(){return"Error in "+e.Dilation2DBackpropFilter+", dy must have the same rank as output "+N.length+", but got "+d.rank}));for(var z=e.util.toNestedArray(N,f.data.get(d.dataId).values),W=e.util.makeZerosNestedTypedArray(s.shape,s.dtype),_=0;_<m;++_)for(var H=0;H<b;++H)for(var O=H*M-x.top,C=0;C<k;++C)for(var B=C*F-x.left,E=0;E<S;++E){for(var P=Number.MIN_SAFE_INTEGER,R=0,q=0,L=0;L<A;++L){var U=O+L*D;if(U>=0&&U<g)for(var V=0;V<T;++V){var G=B+V*w;if(G>=0&&G<I){var j=c[_][U][G][E]+v[L][V][E];j>P&&(P=j,R=L,q=V)}}}W[R][q][E]+=z[_][H][C][E]}return{dataId:f.write(e.util.toTypedArray(W,i.dtype),s.shape,s.dtype),shape:s.shape,dtype:s.dtype}}},k={kernelName:e.Dilation2DBackpropInput,backendName:"cpu",kernelFunc:function(t){var r=t.inputs,a=t.backend,n=t.attrs,o=r,i=o.x,s=o.filter,d=o.dy,p=n,u=p.strides,h=p.pad,l=p.dilations,f=a,c=e.util.toNestedArray(i.shape,f.data.get(i.dataId).values),v=e.util.toNestedArray(s.shape,f.data.get(s.dataId).values),y=e.backend_util.computeDilation2DInfo(i.shape,s.shape,u,h,"NHWC",l),m=y.batchSize,g=y.inHeight,I=y.inWidth,S=y.inChannels,b=y.outHeight,k=y.outWidth,x=y.padInfo,M=y.strideHeight,F=y.strideWidth,A=y.filterHeight,T=y.filterWidth,D=y.dilationHeight,w=y.dilationWidth,N=y.outShape;e.util.assert(d.rank===N.length,(function(){return"Error in "+e.Dilation2DBackpropInput+", dy must have the same rank as output "+N.length+", but got "+d.rank}));for(var z=e.util.toNestedArray(N,f.data.get(d.dataId).values),W=e.util.makeZerosNestedTypedArray(i.shape,i.dtype),_=0;_<m;++_)for(var H=0;H<b;++H)for(var O=H*M-x.top,C=0;C<k;++C)for(var B=C*F-x.left,E=0;E<S;++E){for(var P=Number.MIN_SAFE_INTEGER,R=O<0?0:O,q=B<0?0:B,L=0;L<A;++L){var U=O+L*D;if(U>=0&&U<g)for(var V=0;V<T;++V){var G=B+V*w;if(G>=0&&G<I){var j=c[_][U][G][E]+v[L][V][E];j>P&&(P=j,R=U,q=G)}}}W[_][R][q][E]+=z[_][H][C][E]}return{dataId:f.write(e.util.toTypedArray(W,i.dtype),i.shape,i.dtype),shape:i.shape,dtype:i.dtype}}};function x(t,e){return{kernelName:t,backendName:"cpu",kernelFunc:function(r){var a=r.inputs,n=r.backend,o=a,s=o.a,d=o.b,p=n;i([s,d],t);var u=p.data.get(s.dataId).values,h=p.data.get(d.dataId).values,l=e(s.shape,d.shape,u,h,s.dtype),f=l[0],c=l[1];return{dataId:p.write(f,c,s.dtype),shape:c,dtype:s.dtype}}}}function M(t){return function(r,a,n,o,i){var s=e.backend_util.assertAndGetBroadcastShape(r,a),d=s.length,p=e.util.computeStrides(s),u=e.util.sizeFromShape(s),h=e.util.getTypedArrayFromDType(i,u),l=r.length,f=a.length,c=e.util.computeStrides(r),v=e.util.computeStrides(a),y=e.backend_util.getBroadcastDims(r,s),m=e.backend_util.getBroadcastDims(a,s);if(y.length+m.length===0)for(var g=0;g<h.length;++g)h[g]=t(n[g%n.length],o[g%o.length]);else{var I=function(r){var a=e.util.indexToLoc(r,d,p),i=a.slice(-l);y.forEach((function(t){return i[t]=0}));var s=e.util.locToIndex(i,l,c),u=a.slice(-f);m.forEach((function(t){return u[t]=0}));var g=e.util.locToIndex(u,f,v);h[r]=t(n[s],o[g])};for(g=0;g<h.length;++g)I(g)}return[h,s]}}var F=M((function(t,e){return t/e})),A=x(e.Div,F),T={kernelName:e.FlipLeftRight,backendName:"cpu",kernelFunc:function(t){for(var r=t.inputs,a=(t.attrs,t.backend),n=r.image,o=a,i=e.util.getTypedArrayFromDType(n.dtype,e.util.sizeFromShape(n.shape)),s=n.shape,d=s[0],p=s[1],u=s[2],h=s[3],l=o.data.get(n.dataId).values,f=0;f<d;f++)for(var c=f*u*p*h,v=0;v<p;v++)for(var y=v*(u*h),m=0;m<u;m++)for(var g=m*h,I=0;I<h;I++){var S=[d,v,m,I][2],b=Math.round(u-S),k=c+y+g+I,x=l[k];if(b>=0&&b<u)x=l[c+y+b*h+I];i[k]=x}return{dataId:o.write(i,n.shape,n.dtype),shape:n.shape,dtype:n.dtype}}};var D={kernelName:e.Identity,backendName:"cpu",kernelFunc:function(t){var e=t.inputs,r=t.backend,a=e.x;return r.incRef(a.dataId),{dataId:a.dataId,shape:a.shape,dtype:a.dtype}}},w={kernelName:e.Max,backendName:"cpu",kernelFunc:function(t){var r=t.inputs,a=t.attrs,n=t.backend,o=r.x,s=a,d=s.reductionIndices,p=s.keepDims,u=n,h=o.shape,l=h.length,f=e.util.parseAxisParam(d,h),c=f,v=e.backend_util.getAxesPermutation(c,l),g=u.data.get(o.dataId).values;if(null!=v){for(var I=new Array(l),S=0;S<I.length;S++)I[S]=h[v[S]];g=m(g,h,o.dtype,v,I),c=e.backend_util.getInnerMostAxes(c.length,l),h=I}i(o,"max"),e.backend_util.assertAxesAreInnerMostDims("max",c,l);var b=e.backend_util.computeOutAndReduceShapes(h,c),k=b[0],x=b[1],M=y(g,e.util.sizeFromShape(x),k,o.dtype),F=u.write(M,k,o.dtype),A=k;p&&(A=I=e.backend_util.expandShapeToKeepDim(k,f));return{dataId:F,shape:A,dtype:o.dtype}}};var N={kernelName:e.MaxPoolWithArgmax,backendName:"cpu",kernelFunc:function(t){var r=t.inputs,a=t.attrs,n=t.backend,o=r.x,p=a,u=p.filterSize,h=p.strides,l=p.pad,f=p.includeBatchInIndex,c=n;i(o,"MaxPoolWithArgmax");var v=c.data.get(o.dataId).values,y=e.backend_util.computePool2DInfo(o.shape,u,h,[1,1],l),m=function(t,r,a,n,o){var i=s(t,0,a,e.util.computeStrides(r),o,"max"),p=d(t,r,a,o,!0,n);return[i.values,p.values]}(v,o.shape,o.dtype,f,y),g=m[0],I=m[1],S=c.write(g,y.outShape,o.dtype),b=c.write(I,y.outShape,o.dtype);return[{dataId:S,shape:y.outShape,dtype:o.dtype},{dataId:b,shape:y.outShape,dtype:"int32"}]}},z=e.kernel_impls.nonMaxSuppressionV4Impl,W={kernelName:e.NonMaxSuppressionV4,backendName:"cpu",kernelFunc:function(t){var e=t.inputs,r=t.backend,a=t.attrs,n=e,o=n.boxes,s=n.scores,d=a,p=d.maxOutputSize,u=d.iouThreshold,h=d.scoreThreshold,l=d.padToMaxOutputSize,f=r;i(o,"NonMaxSuppressionPadded");var c=f.data.get(o.dataId).values,v=f.data.get(s.dataId).values,y=z(c,v,p,u,h,l);return[y.selectedIndices,y.validOutputs]}},_=e.kernel_impls.nonMaxSuppressionV5Impl,H={kernelName:e.NonMaxSuppressionV5,backendName:"cpu",kernelFunc:function(t){var e=t.inputs,r=t.backend,a=t.attrs,n=e,o=n.boxes,s=n.scores,d=a,p=d.maxOutputSize,u=d.iouThreshold,h=d.scoreThreshold,l=d.softNmsSigma,f=r;i(o,"NonMaxSuppressionWithScore");var c=f.data.get(o.dataId).values,v=f.data.get(s.dataId).values,y=_(c,v,p,u,h,l);return[y.selectedIndices,y.selectedScores]}};var O={kernelName:e.PadV2,backendName:"cpu",kernelFunc:function(t){var r=t.inputs,a=t.backend,n=t.attrs,o=r.x,s=n.paddings,d=n.constantValue;i(o,"pad");var p=s.map((function(t,e){return t[0]+o.shape[e]+t[1]})),u=s.map((function(t){return t[0]})),h=a.data.get(o.dataId).values,l=e.util.sizeFromShape(o.shape),f=o.shape.length,c=e.util.computeStrides(o.shape),v=e.util.sizeFromShape(p),y=p.length,m=e.util.computeStrides(p),g=e.util.getTypedArrayFromDType(o.dtype,v);0!==d&&g.fill(d);for(var I=0;I<l;I++){var S=e.util.indexToLoc(I,f,c).map((function(t,e){return t+u[e]}));g[e.util.locToIndex(S,y,m)]=h[I]}return{dataId:a.write(g,p,o.dtype),shape:p,dtype:o.dtype}}};function C(t){var e=t.inputs,r=t.backend,a=t.attrs,n=e.x,o=a.shape;return r.incRef(n.dataId),{dataId:n.dataId,shape:o,dtype:n.dtype}}var B={kernelName:e.Reshape,backendName:"cpu",kernelFunc:C},E={kernelName:e.RotateWithOffset,backendName:"cpu",kernelFunc:function(t){for(var r=t.inputs,a=t.attrs,n=t.backend,o=r.image,i=a,s=i.radians,d=i.fillValue,p=i.center,u=n,h=e.util.getTypedArrayFromDType(o.dtype,e.util.sizeFromShape(o.shape)),l=o.shape,f=l[0],c=l[1],v=l[2],y=l[3],m=e.backend_util.getImageCenter(p,c,v),g=m[0],I=m[1],S=Math.sin(s),b=Math.cos(s),k=u.data.get(o.dataId).values,x=0;x<f;x++)for(var M=x*v*c*y,F=0;F<c;F++)for(var A=F*(v*y),T=0;T<v;T++)for(var D=T*y,w=0;w<y;w++){var N=[f,F,T,w],z=N[2],W=N[1],_=(z-g)*b-(W-I)*S,H=(z-g)*S+(W-I)*b;_=Math.round(_+g),H=Math.round(H+I);var O=d;if("number"!=typeof d&&(O=3===w?255:d[w]),_>=0&&_<v&&H>=0&&H<c)O=k[M+H*(v*y)+_*y+w];h[M+A+D+w]=O}return{dataId:u.write(h,o.shape,o.dtype),shape:o.shape,dtype:o.dtype}}};function P(t){var e=t.inputs,r=t.attrs,a=t.backend,n=e.x,o=r.perm;i(n,"transpose");for(var s=n.shape.length,d=new Array(s),p=0;p<d.length;p++)d[p]=n.shape[o[p]];var u=m(a.data.get(n.dataId).values,n.shape,n.dtype,o,d);return{dataId:a.write(u,d,n.dtype),shape:d,dtype:n.dtype}}var R={kernelName:e.Transpose,backendName:"cpu",kernelFunc:P};for(var q={kernelName:e.SpaceToBatchND,backendName:"cpu",kernelFunc:function(t){var r=t.inputs,a=t.backend,n=t.attrs,o=r.x,s=n.blockShape,d=n.paddings;i([o],"spaceToBatchND");var p=e.util.sizeFromShape(s),u=[[0,0]];u.push.apply(u,d);for(var h=1+s.length;h<o.shape.length;++h)u.push([0,0]);var l=O.kernelFunc({inputs:{x:o},backend:a,attrs:{paddings:u,constantValue:0}}),f=e.backend_util.getReshaped(l.shape,s,p,!1),c=e.backend_util.getPermuted(f.length,s.length,!1),v=e.backend_util.getReshapedPermuted(l.shape,s,p,!1),y=C({inputs:{x:l},backend:a,attrs:{shape:f}}),m=P({inputs:{x:y},backend:a,attrs:{perm:c}}),g=C({inputs:{x:m},backend:a,attrs:{shape:v}});return a.disposeIntermediateTensorInfo(l),a.disposeIntermediateTensorInfo(y),a.disposeIntermediateTensorInfo(m),g}},L={kernelName:e.Square,backendName:"cpu",kernelFunc:function(t){var e=t.inputs,r=t.backend,a=e.x,n=r;i(a,"square");for(var o=n.data.get(a.dataId).values,s=new Float32Array(o.length),d=0;d<o.length;++d){var p=o[d];s[d]=p*p}return{dataId:n.write(s,a.shape,a.dtype),shape:a.shape,dtype:a.dtype}}},U=M((function(t,e){var r=t-e;return r*r})),V=x(e.SquaredDifference,U),G=0,j=[I,S,k,b,A,T,D,N,w,W,H,O,B,E,q,L,V,R];G<j.length;G++){var Y=j[G];e.registerKernel(Y)}t.MathBackendCPU=v,t.shared=g,t.version_cpu="2.4.0",Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=tf-backend-cpu.min.js.map
